using System.Collections.Generic;
using UnityEngine;
using stats;

namespace Photon.Pun.Darse.Tales
{
    public abstract class Character : MonoBehaviourPun
    {
        public bool player = false;
        public float currentHP, currentMP, currentAbsorb, maximumHP, maximumMP;
        public float[] rates;
        public List<BlockDamageSlot> blockDamageSlots;
        
        #region Components
        public Stats stats;
        public BuffList buffListComponent;
        public BuffUse buffUseComponent;
        public PassiveUse passiveUseComponent;
        public PassiveCheck passiveCheckComponent;
        public SpellList spellListComponent;
        public SpellCaster spellCasterComponent;
        public ICombatUI combatUIInterface;
        #endregion

        #region Character metods
        public virtual void Initialization() { }

        public void NewRates()
        {
            rates[0] = Rates.NewStatsRate(Manager.level);
            rates[1] = Rates.NewDefenseRate(Manager.level);
            rates[2] = Rates.NewAttackSpeedRate(Manager.level);
        }

        public void DealDamage(DamageSlot _damageSlot)
        {
            if (stats == null) return;

            if (player && blockDamageSlots != null)
            {
                if (blockDamageSlots.Count > 0)
                {
                    blockDamageSlots[0].currentBlocks--;
                    if (blockDamageSlots[0].currentBlocks <= 0)
                    {
                        blockDamageSlots.Remove(blockDamageSlots[0]);
                    }
                    return;
                }
            }

            if (_damageSlot.damageType == DamageTypes.physical)
            {
                bool _decreaseDamage = false;
                float _defense = 1 - stats.stats_list[45];
                float _currentDamage = _damageSlot.damage;

                if (_defense < 0.2f) _defense = 0.2f;

                // evade 0% 
                int _random = Random.Range(0, 100);
                if (rates[0] * stats.stats_list[43] >= _random && !_decreaseDamage) { _currentDamage = 0; passiveCheckComponent.CheckPassive(TriggerPassives.Evade); _decreaseDamage = true; }
                // block 20%
                _random = Random.Range(0, 100);
                if (rates[0] * stats.stats_list[44] >= _random && !_decreaseDamage) { _currentDamage = (_defense * _damageSlot.damage) * 0.2f; passiveCheckComponent.CheckPassive(TriggerPassives.Block); _decreaseDamage = true; }
                // parry 50%
                _random = Random.Range(0, 100);
                if (rates[0] * stats.stats_list[45] >= _random && !_decreaseDamage) { _currentDamage = (_defense * _damageSlot.damage) * 0.5f; passiveCheckComponent.CheckPassive(TriggerPassives.Parry); _decreaseDamage = true; }
                // full damage 100%
                if (!_decreaseDamage) { _currentDamage = _defense * _damageSlot.damage; passiveCheckComponent.CheckPassive(TriggerPassives.HitMelee); }

                if (player == false)
                {
                    CreateBloodEffect();
                    if (PhotonNetwork.IsMasterClient)
                    {
                        photonView.RPC("Damage", RpcTarget.Others, _currentDamage);
                    }
                    else
                    {
                        photonView.RPC("Damage", RpcTarget.Others, _currentDamage);
                    }
                    currentHP = currentHP - _currentDamage;
                    if (currentHP <= 0) { Death(); }
                    if (combatUIInterface != null)
                    {
                        combatUIInterface.CombatText((int)Mathf.Ceil(_currentDamage), _damageSlot.damageType);
                        combatUIInterface.SetPercentageHP(currentHP / stats.stats_list[0], currentHP);
                    }
                    else Debug.LogError("combatUIInterface == null", this);                    
                }
                else
                {
                    CombatText(_currentDamage, _damageSlot.damageType);
                    currentHP -= _currentDamage;
                }
            }
        }

        [PunRPC]
        public void Damage(float _object)
        {
            CreateBloodEffect();
            currentHP -= (float)_object;
            if (PhotonNetwork.IsMasterClient)
            { 
                if (currentHP <= 0){ Death(); } 
            }

        }
